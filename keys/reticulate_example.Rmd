---
title: "Python in R with reticulate"
author: "Allison Horst"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE)

library(tidyverse)
library(here)
library(reticulate)

# py_install("library_name")
```

## 2. Python in R Markdown with `reticulate()`

### Some background: 

[`reticulate`](https://rstudio.github.io/reticulate/): "R interface to Python modules, classes, and functions. When calling into Python R data types are automatically converted to their equivalent Python types. When values are returned from Python to R they are converted back to R types. The reticulate package is compatible with all versions of Python >= 2.7. Integration with NumPy requires NumPy version 1.6 or higher."

- **Note 1:** you need to have Python >=2.7 installed on your computer (what I did: Anaconda download). The `reticulate` package **does not** bring Python along with it. Then you can follow along [here](https://rstudio.github.io/reticulate/) to get up and running with functioning Python code chunks in R Markdown. 

#### a. Tell R which Python version to use (if needed)
```{r}
# use_python("/opt/anaconda3/bin/python")
# py_config()
```

#### b. Install Python libraries 

```{r}
# py_install("scipy")
```

There are a number of ways to do this, some easier than this. Check out: https://rstudio.github.io/reticulate/index.html for a lot of examples and information. 

#### c. Just generally working in a Py code chunk

...nothing super special here.

```{python}
a = 4
b = 10
c = a + b
c
```

Looks very similar to what we'd do in R: 
```{r}
a = 4
b = 10
c = a + b
c
```

#### d. I already have `pandas`, `matplotlib.pyplot` and `dplython` installed, so I can import them here:

- `pandas` is used for exploring & wrangling data frames (also using tidy structure)
- `matplotlib` is a basic graphics module
- `dplython` has functions for wrangling that are similar to `dplyr` in R

Here, I give it a shorter name ("pd") to make it quicker to refer to when I use it later on, but don't have to. 
```{python}
# Attach modules
import pandas as pd
import matplotlib.pyplot as mp
# Get specific pieces from dplython
from dplython import (DplyFrame, X, head, arrange, mutate, select, group_by, summarize)
  
```

#### e. Reading in and exploring data

Comparison of common functions: 
https://pandas.pydata.org/docs/getting_started/comparison/comparison_with_r.html

**Example 1:** Starting from `my_data.csv`

- Do some exploring first with R code (View, head, tail, names, dim)
```{r}

df_r <- read_csv(here("data", "my_data.csv"))

View(df_r) # Return entire data frame
head(df_r) # Return first 6 lines
tail(df_r) # Return last 6 lines
names(df_r) # Return variable names
dim(df_r) # Return dimensions

```

Let's do the same with Python code!

First: read it in (`pandas.read_csv`)
```{python}
df_py = DplyFrame(pd.read_csv("../data/my_data.csv"))
```

Then look at it using similar functions: 
```{python}
print(df_py) # View it
```

```{python}
df_py.head(3) # Return the first 3 rows
```

```{python}
df_py.tail(2) # Return the last 2 rows
```

```{python}
list(df_py) # Return the column names
````

```{python}
df_py.shape # Returns dimensions
```

### Now let's do some wrangling and see the similarities between R and Python for some staples

- Only keep observations where weight is greater than 12 pounds
- Just keep columns species, weight_lb and height_m
- Add a new column for the weight/height ratio
- Make a graph with ggplot2

```{r}
# Do the wrangling:
foo_r <- df_r %>% 
  filter(weight_lb > 12) %>% 
  select(species, weight_lb, height_m) %>% 
  mutate(ratio = weight_lb / height_m)

# Then make a graph with ggplot2:
ggplot(data = foo_r, aes(x = weight_lb, y = height_m)) +
  geom_point(size = 4)
```

Let's do the same in Python
Note: `>>` operator is in `dplython` module
```{python}
foo_py = df_py >> select(X.weight_lb, X.height_m) >> X.query('weight_lb > 12') >> X.assign(ratio = X['weight_lb'] / X['height_m'])

print(foo_py)

# So it's the same thing, and we can plot with matplotlib
```

```{python}
mp.scatter('weight_lb', 'height_m', s = 100, data = foo_py)
```
